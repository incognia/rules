#!/usr/bin/env bash
# Pre-commit hook opcional para validar uso correcto de CST
# Bloquea commits si detecta líneas nuevas con 'CST' sin que el diff incluya
# referencias explícitas a TZ=America/Mexico_City en los cambios.
# 
# Activación:
#   git config core.hooksPath .githooks
# 
# Saltar chequeo (commit puntual):
#   SKIP_CST_CHECK=1 git commit -m "..."

set -euo pipefail

# Permitir saltar con variable de entorno
if [[ "${SKIP_CST_CHECK:-}" == "1" ]]; then
  exit 0
fi

# Obtener diff de lo que se va a commitear (index vs HEAD)
# Incluye solo líneas añadidas
DIFF_ADDED=$(git diff --cached --unified=0 | awk '/^\+/{print}')

# Si no hay líneas añadidas, salir
if [[ -z "$DIFF_ADDED" ]]; then
  exit 0
fi

# ¿Se mencionó CST en líneas añadidas?
if echo "$DIFF_ADDED" | grep -q "CST"; then
  # ¿También se añadió una referencia a TZ=America/Mexico_City?
  if ! echo "$DIFF_ADDED" | grep -q "TZ=America/Mexico_City"; then
    cat >&2 <<'EOF'
[pre-commit] Detectado uso de 'CST' en líneas añadidas sin referencia a TZ=America/Mexico_City.
Para evitar timestamps incorrectos (UTC con sufijo CST), añade conversión explícita, por ejemplo:
  TZ=America/Mexico_City date '+%F %H:%M %Z'

Si necesitas omitir este chequeo en un commit puntual:
  SKIP_CST_CHECK=1 git commit -m "..."
EOF
    exit 1
  fi
fi

exit 0

